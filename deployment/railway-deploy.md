# Railway Deployment Guide for CaboAI

Complete guide to deploy the NestJS backend, FastAPI AI service, and PostgreSQL database on Railway.

## üöÄ Quick Deploy Links

### 1. PostgreSQL Database
[![Deploy on Railway](https://railway.app/button.svg)](https://railway.app/template/postgres)

### 2. Backend Service (NestJS)
```bash
# Connect your GitHub repo to Railway
railway login
railway link
railway up
```

### 3. AI Service (FastAPI)
```bash
# Deploy from ai-service directory
cd ai-service
railway up
```

## üìã Prerequisites

1. **Railway Account**: Sign up at [railway.app](https://railway.app)
2. **GitHub Repository**: Code must be in a GitHub repository
3. **Environment Variables**: Prepare all required environment variables

## üóÑÔ∏è Database Setup

### Step 1: Create PostgreSQL Database

1. Go to [Railway Dashboard](https://railway.app/dashboard)
2. Click **New Project** ‚Üí **Provision PostgreSQL**
3. Wait for database deployment
4. Note the connection details from the **Connect** tab

### Step 2: Configure Database Environment Variables

Railway automatically provides these variables:
- `DATABASE_URL`
- `PGHOST`
- `PGPORT`
- `PGDATABASE`
- `PGUSER`
- `PGPASSWORD`

### Step 3: Initialize Database Schema

Option A: Using Railway CLI
```bash
# Connect to your database
railway connect postgres

# Run initialization script
\i database/init-scripts/01-create-database.sql
\i database/init-scripts/02-seed-data.sql
```

Option B: Using Database URL
```bash
# Use any PostgreSQL client
psql $DATABASE_URL -f database/init-scripts/01-create-database.sql
psql $DATABASE_URL -f database/init-scripts/02-seed-data.sql
```

## üéØ Backend Deployment (NestJS)

### Step 1: Prepare Repository

Ensure your repository has:
```
backend/
‚îú‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ railway.json
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ .env.production
```

### Step 2: Deploy to Railway

1. **Create New Service**:
   - Go to Railway Dashboard
   - Click **New** ‚Üí **GitHub Repo**
   - Select your repository
   - Choose `/backend` as root directory

2. **Configure Build Settings**:
   ```json
   {
     "build": {
       "builder": "NIXPACKS"
     },
     "deploy": {
       "startCommand": "npm run start:prod",
       "healthcheckPath": "/health"
     }
   }
   ```

3. **Set Environment Variables**:
   ```bash
   # Required variables
   NODE_ENV=production
   PORT=3000
   
   # Database (auto-generated by Railway)
   DATABASE_URL=${{Postgres.DATABASE_URL}}
   PGHOST=${{Postgres.PGHOST}}
   PGPORT=${{Postgres.PGPORT}}
   PGUSER=${{Postgres.PGUSER}}
   PGPASSWORD=${{Postgres.PGPASSWORD}}
   PGDATABASE=${{Postgres.PGDATABASE}}
   
   # Security
   JWT_SECRET=your_super_secret_jwt_key_here
   JWT_REFRESH_SECRET=your_refresh_secret_here
   
   # CORS (will be updated with frontend URL)
   CORS_ORIGIN=https://caboai.netlify.app
   
   # External Services
   OPENAI_API_KEY=your_openai_api_key
   WHATSAPP_TOKEN=your_whatsapp_token
   WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
   SENDGRID_API_KEY=your_sendgrid_api_key
   
   # Los Cabos specific
   CURRENCY_API_KEY=your_currency_api_key
   BANXICO_TOKEN=your_banxico_token
   ```

### Step 3: Connect to Database

1. In Railway Dashboard, go to your backend service
2. Click **Variables** tab
3. Add reference variables:
   ```
   DATABASE_URL = ${{Postgres.DATABASE_URL}}
   PGHOST = ${{Postgres.PGHOST}}
   PGPORT = ${{Postgres.PGPORT}}
   PGUSER = ${{Postgres.PGUSER}}
   PGPASSWORD = ${{Postgres.PGPASSWORD}}
   PGDATABASE = ${{Postgres.PGDATABASE}}
   ```

## ü§ñ AI Service Deployment (FastAPI)

### Step 1: Create AI Service

1. **Create New Service**:
   - Railway Dashboard ‚Üí **New** ‚Üí **GitHub Repo**
   - Select repository
   - Choose `/ai-service` as root directory

2. **Configure Python Build**:
   ```json
   {
     "build": {
       "builder": "NIXPACKS"
     },
     "deploy": {
       "startCommand": "uvicorn main:app --host 0.0.0.0 --port $PORT"
     }
   }
   ```

### Step 2: Set AI Service Environment Variables

```bash
# Application
ENVIRONMENT=production
PORT=8000

# Security
AI_SERVICE_API_KEY=your_ai_service_api_key
SECRET_KEY=your_secret_key

# Database connection
DATABASE_URL=${{Postgres.DATABASE_URL}}

# OpenAI
OPENAI_API_KEY=your_openai_api_key
OPENAI_MODEL=gpt-4

# CORS
CORS_ORIGIN=https://caboai.netlify.app

# Los Cabos configuration
TIMEZONE=America/Mazatlan
DEFAULT_LANGUAGE=es
```

### Step 3: Connect Services

1. Add backend service URL to AI service:
   ```
   BACKEND_URL = ${{NestJS-Backend.RAILWAY_PUBLIC_DOMAIN}}
   ```

2. Add AI service URL to backend:
   ```
   AI_SERVICE_URL = ${{FastAPI-AI.RAILWAY_PUBLIC_DOMAIN}}
   ```

## üîó Service Interconnection

### Backend ‚Üí AI Service Connection

In backend environment variables:
```bash
AI_SERVICE_URL=https://your-ai-service.railway.app
AI_SERVICE_API_KEY=your_ai_service_api_key
```

### AI Service ‚Üí Backend Connection

In AI service environment variables:
```bash
BACKEND_URL=https://your-backend.railway.app
BACKEND_API_KEY=your_backend_api_key
```

## üåê CORS Configuration

### For Development
```javascript
// backend/src/config/cors.config.ts
origin: [
  'http://localhost:3000',
  'http://localhost:5173',
  'https://caboai.netlify.app'
]
```

### For Production
```javascript
origin: [
  'https://caboai.netlify.app',
  'https://letty-ai.netlify.app',
  process.env.CORS_ORIGIN
]
```

## üìä Health Checks

Both services include health check endpoints:

### Backend Health Check
```
GET https://your-backend.railway.app/health
```

### AI Service Health Check
```
GET https://your-ai-service.railway.app/health
```

## üîç Monitoring & Logs

### View Logs
```bash
# Backend logs
railway logs --service backend

# AI service logs
railway logs --service ai-service

# Database logs
railway logs --service postgres
```

### Monitoring URLs
- Backend: `https://your-backend.railway.app/health`
- AI Service: `https://your-ai-service.railway.app/health`
- Database: Monitor via Railway dashboard

## üîß Environment Variables Reference

### Complete Backend Variables
```env
# Application
NODE_ENV=production
PORT=3000
APP_NAME=CaboAI Backend

# Database
DATABASE_URL=${{Postgres.DATABASE_URL}}
PGHOST=${{Postgres.PGHOST}}
PGPORT=${{Postgres.PGPORT}}
PGUSER=${{Postgres.PGUSER}}
PGPASSWORD=${{Postgres.PGPASSWORD}}
PGDATABASE=${{Postgres.PGDATABASE}}

# Security
JWT_SECRET=your_jwt_secret_256_bit_key
JWT_REFRESH_SECRET=your_refresh_secret_key

# CORS
CORS_ORIGIN=https://caboai.netlify.app

# External APIs
OPENAI_API_KEY=sk-your_openai_key
WHATSAPP_TOKEN=your_whatsapp_business_token
WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
SENDGRID_API_KEY=SG.your_sendgrid_key

# Los Cabos
CURRENCY_API_KEY=your_currency_api_key
BANXICO_TOKEN=your_banxico_token
TIMEZONE=America/Mazatlan

# AI Service
AI_SERVICE_URL=${{FastAPI-AI.RAILWAY_PUBLIC_DOMAIN}}
AI_SERVICE_API_KEY=your_ai_service_key
```

### Complete AI Service Variables
```env
# Application
ENVIRONMENT=production
PORT=8000

# Security
AI_SERVICE_API_KEY=your_ai_service_api_key
SECRET_KEY=your_secret_key

# Database
DATABASE_URL=${{Postgres.DATABASE_URL}}

# OpenAI
OPENAI_API_KEY=sk-your_openai_key
OPENAI_MODEL=gpt-4

# CORS
CORS_ORIGIN=https://caboai.netlify.app

# Configuration
TIMEZONE=America/Mazatlan
DEFAULT_LANGUAGE=es
SUPPORTED_LANGUAGES=es,en
```

## üöÄ Deployment Commands

### One-Click Deploy
```bash
# Deploy everything at once
./scripts/deploy-all.sh
```

### Individual Service Deploy
```bash
# Deploy backend only
railway up --service backend

# Deploy AI service only
railway up --service ai-service
```

### Database Migration
```bash
# Run migrations
railway run --service backend npm run migration:run
```

## ‚úÖ Post-Deployment Checklist

- [ ] Database schema created successfully
- [ ] Backend service health check passes
- [ ] AI service health check passes
- [ ] Services can communicate with each other
- [ ] CORS configured for frontend domain
- [ ] Environment variables set correctly
- [ ] Logs showing no errors
- [ ] Test API endpoints manually

## üîó Useful Links

- **Railway Dashboard**: https://railway.app/dashboard
- **Backend Service**: https://your-backend.railway.app
- **AI Service**: https://your-ai-service.railway.app
- **Frontend**: https://caboai.netlify.app
- **Documentation**: https://docs.railway.app

## üÜò Troubleshooting

### Common Issues

1. **Database Connection Failed**
   ```bash
   # Check database variables
   railway variables --service postgres
   
   # Test connection
   railway connect postgres
   ```

2. **CORS Errors**
   ```bash
   # Update CORS_ORIGIN variable
   railway variables set CORS_ORIGIN=https://your-frontend.netlify.app
   ```

3. **Service Communication Issues**
   ```bash
   # Check service URLs
   echo $AI_SERVICE_URL
   echo $BACKEND_URL
   ```

4. **Build Failures**
   ```bash
   # Check build logs
   railway logs --service backend
   ```

### Support
- Railway Discord: https://discord.gg/railway
- Documentation: https://docs.railway.app
- GitHub Issues: Create issue in your repository